const RarityTemplate = {
  header: "--BaRandom by LoH\n--Use with: !bset tweakdefs0 <mod.b64>",
  segments: [
    "rename_list={}local a={\"Uncommon\",\"Rare\",\"Exceptional\",\"Epic\",\"Exotic\",\"Legendary\",\"Mythical\",\"Miracle\",\"Divine\",\"Eternal\",\"Supreme\",\"Omega\",\"Unique\",\"Jackpot\",\"Immortal\",\"Absurd\",\"Godlike\",\"TooRNG\",\"Insanely Lucky\",\"Dope\",\"Admin\",\"GOD\",\"ERROR\",\"Super Sayan\",\"Beyond\",\"MGGW\",\"AMBO\",\"Beyond All Reason\"}local b=",
    ";local c=",
    ";local d=",
    ";local e=",
    ";local f=",
    ";local g={cancloak=true,cloakcost=5,cloakcostmoving=15,mincloakdistance=75}local h={cancloak=true,cloakcost=5,cloakcostmoving=15,mincloakdistance=50}local i={[\"Glass Cannon\"]={{\"Phantom\",g,{hp=0.85}},{\"Volatile\",{},{dmg=1.3,hp=0.6}},{\"Overcharged\",{},{rld=0.8,energypershot=1.5}},{\"Plague\",{},{fs=1.0,aoe=1.15,dmg=0.9}},{\"Bouncer\",{},{impf=6.0,impb=2.0,dmg=0.6}}},[\"Tank\"]={{\"Juggernaut\",{},{hp=1.6,spd=0.7,turnrate=0.75}},{\"Regenerator\",{},{autoheal=3.0}},{\"Fortified\",{},{hp=1.3,rld=1.2}},{\"GravWell\",{},{impf=-2.0,aoe=1.4,dmg=0.8}}},[\"Sniper\"]={{\"Phantom\",g,{hp=0.9}},{\"Marksman\",{},{rng=1.3,acc=0.7,aoe=0.7}},{\"Piercing\",{},{dmg=1.2,aoe=0.5}},{\"Drunk\",{},{wob=4000,dnc=60,acc=2.5,aoe=1.3}}},[\"Brawler\"]={{\"Swift\",{},{spd=1.4,hp=0.7,maxacc=1.3}},{\"Berserker\",{},{dmg=1.2,aoe=1.3,acc=1.4}},{\"Siege\",{},{aoe=1.4,dmg=1.15,spd=0.85}},{\"Plague\",{},{fs=1.0,aoe=1.15,dmg=0.9}},{\"Bouncer\",{},{impf=6.0,impb=2.0,dmg=0.6}}},[\"Fortress\"]={{\"Juggernaut\",{},{hp=1.6}},{\"Shielded\",{},{shield_power=1.4,shield_radius=1.2}},{\"Siren\",{},{impf=3.5,impb=1.0,dmg=0.7,aoe=1.15}}},[\"Watchtower\"]={{\"Phantom\",h,{hp=0.9}},{\"Marksman\",{},{rng=1.3,acc=0.7,aoe=0.7}},{\"GravWell\",{},{impf=-2.0,aoe=1.4,dmg=0.8}}},[\"Suppressor\"]={{\"Siege\",{},{aoe=1.4,dmg=1.15,acc=1.3}},{\"Berserker\",{},{dmg=1.3,aoe=1.3}},{\"Siren\",{},{impf=3.5,impb=1.0,dmg=0.7,aoe=1.15}},{\"Drunk\",{},{wob=4000,dnc=60,acc=2.5,aoe=1.3}}}}local function j(k)local k=k or 0;if k+1<=#a and math.random()<b then k=j(k+1)end;return k end;local function l(m)local n=j(m)if n<m then n=m end;return n end;local function o(k,p,n,q,r)if k then local s=k*p^n+(p-1)*k;if k>0 and s<=0 then s=k*p^n end;if q then s=math.floor(s)end;return s*(r or 1)end end;local function t(s,u,p,q)if p and s[u]then s[u]=s[u]*p;if q then s[u]=math.floor(s[u])end end end;local v={{\"Glass Cannon\",0.88,1.05,1.12,1.05,0.91,1.05,0.96},{\"Tank\",1.22,1.0,1.01,1.04,0.97,1.04,0.97},{\"Sniper\",1.03,1.04,1.07,1.14,0.98,0.95,0.91},{\"Brawler\",1.06,1.10,1.05,1.0,0.88,1.10,0.97}}local w={{\"Fortress\",1.20,1.0,1.08,1.04,0.97,1.04,0.97},{\"Watchtower\",1.03,1.0,1.05,1.14,0.98,0.95,0.91},{\"Suppressor\",1.06,1.0,1.04,1.0,0.88,1.12,0.97}}local x={{\"armthund\",\"armkam\"},{\"armpw\",\"armrock\",\"armham\",\"armwar\",\"armflea\"},{\"armmlv\",\"armfav\",\"armflash\",\"armpincer\",\"armstump\",\"armart\",\"armjanus\"},{\"armdecade\",\"armpt\",\"armpship\",\"armroy\",\"armsub\"},{\"armsh\",\"armanac\",\"armmh\"},{\"armsaber\",\"armsb\",\"armseap\"},{\"armbrawl\",\"armpnix\",\"armlance\",\"armdfly\",\"armblade\",\"armstil\",\"armliche\"},{\"armfast\",\"armamph\",\"armzeus\",\"armmav\",\"armsptk\",\"armfido\",\"armsnipe\",\"armfboy\",\"armspid\",\"armvader\",\"armscab\"},{\"armcroc\",\"armlatnk\",\"armbull\",\"armgremlin\",\"armmart\",\"armmerl\",\"armmanni\"},{\"armcrus\",\"armsubk\",\"armserp\",\"armantiship\",\"armbats\",\"armmship\",\"armepoch\",\"armlship\"},{\"armpincer\",\"armcroc\"},{\"armbanth\",\"armraz\",\"armmar\",\"armvang\",\"armlun\",\"armthor\"},{\"corshad\",\"corbw\"},{\"corak\",\"corstorm\",\"corthud\"},{\"cormlv\",\"corfav\",\"corgator\",\"corgarp\",\"corraid\",\"corlevlr\",\"corwolv\"},{\"coresupp\",\"corpt\",\"corpship\",\"corroy\",\"corsub\"},{\"corsh\",\"corsnap\",\"cormh\",\"corhal\"},{\"corcut\",\"corsb\",\"corseap\"},{\"corape\",\"corhurc\",\"cortitan\",\"corcrwh\"},{\"corpyro\",\"coramph\",\"corcan\",\"corsumo\",\"cortermite\",\"cormort\",\"corhrk\",\"corroach\",\"corsktl\",\"cormando\"},{\"corsala\",\"correap\",\"corparrow\",\"corgol\",\"corban\",\"cormart\",\"corvroc\",\"cortrem\"},{\"corcrus\",\"corshark\",\"corssub\",\"corantiship\",\"corbats\",\"cormship\",\"corblackhy\",\"corfship\"},{\"corgarp\",\"corsala\",\"corparrow\"},{\"corkorg\",\"corkarg\",\"corjugg\",\"corshiva\",\"corcat\",\"corsok\",\"cordemon\"},{\"legkam\",\"legcib\",\"legmos\"},{\"leggob\",\"leglob\",\"legcen\",\"legbal\",\"legkark\"},{\"legscout\",\"leghades\",\"leghelios\",\"leggat\",\"legbar\",\"legmlv\",\"legamphtank\"},{\"legnavyscout\",\"legnavyfrigate\",\"legnavydestro\",\"legnavysub\",\"legnavyartyship\"},{\"legsh\",\"legner\",\"legmh\",\"legcar\"},{\"legspsurfacegunship\",\"legspcarrier\",\"legspbomber\",\"legsptorpgunship\"},{\"legstronghold\",\"legmineb\",\"legatorpbomber\",\"legfort\",\"legphoenix\"},{\"legstr\",\"legamph\",\"legshot\",\"leginc\",\"legsrail\",\"legbart\",\"leginfestor\",\"leghrk\",\"legsnapper\"},{\"legmrv\",\"legaskirmtank\",\"legfloat\",\"legaheattank\",\"legmed\",\"legamcluster\",\"legvcarry\",\"legavroc\",\"leginf\"},{\"leganavycruiser\",\"leganavyheavysub\",\"leganavybattlesub\",\"leganavybattleship\",\"leganavyartyship\",\"leganavymissileship\",\"leganavyflagship\",\"leganavyantiswarm\"},{\"legamphtank\",\"legfloat\",\"legamph\"},{\"legeheatraymech\",\"legeallterrainmech\",\"legjav\",\"legelrpcmech\",\"legehovertank\",\"legerailtank\",\"legeshotgunmech\",\"legkeres\"}}local y={}local z={}for A,B in ipairs(x)do local C={}for A,D in ipairs(B)do if not z[D]then C[#C+1]=D end end;if#C==0 then C=B end;local E=C[math.random(#C)]local n=l(c)y[E]=n;z[E]=true end;local F={}for G,H in pairs(UnitDefs)do if not y[G]then local I=H.weapondefs and H.builder~=true;if I and math.random()<d then local J=j()if J<1 then J=1 end;F[G]=J;y[G]=0 else y[G]=j()end end end;local K={}for G,H in pairs(UnitDefs)do local n=y[G]or 0;if n>=5 and H.weapondefs then if H.speed then K[G]=v[math.random(#v)]elseif H.builder~=true then K[G]=w[math.random(#w)]end end end;local L={}for G,H in pairs(UnitDefs)do local n=y[G]or 0;local M=K[G]if n>=f and M then local N=i[M[1]]if N and math.random()<e then L[G]=N[math.random(#N)]end end end;for G,H in pairs(UnitDefs)do local O=y[G]or 0;local P=H.metalcost and\"metalcost\"or\"buildcostmetal\"local Q=H.energycost and\"energycost\"or\"buildcostenergy\"local R=H.health and\"health\"or\"maxdamage\"if not H.power then H.power=H[P]+H[Q]/60 end;local S=O;if not(O<=#a)then O=#a end;if not(O<=6)and(G==\"armcom\"or G==\"corcom\"or G==\"legcom\")then O=6 end;local J=F[G]if J then if H.customparams then H.customparams.cursed=tostring(J)end;H[R]=o(H[R],0.93,J,true)H.speed=o(H.speed,0.97,J,true)H.maxacc=o(H.maxacc,0.97,J)H.turnrate=o(H.turnrate,0.97,J)H.sightdistance=o(H.sightdistance,0.97,J)H.radardistance=o(H.radardistance,0.97,J)H[P]=o(H[P],0.85,J,true)H[Q]=o(H[Q],0.85,J,true)H.buildtime=o(H.buildtime,0.88,J)if H.weapondefs then for T,U in pairs(H.weapondefs)do if U.interceptor~=1 and U.targetable~=1 then U.range=o(U.range,0.97,J,true)U.reloadtime=o(U.reloadtime,1.04,J)if U.damage then for u,V in pairs(U.damage)do U.damage[u]=o(U.damage[u],0.94,J)end end end end end;if G then table.insert(rename_list,{G,\"prefix\",\"[Cursed Mk.\"..J..\"]\"})table.insert(rename_list,{G,\"desc_prefix\",\"Cursed Mk.\"..J..\" \"})end elseif S>0 then if H.customparams then H.customparams.rarity=tostring(O)end;local M=K[G]local W=M and M[2]or 1.1;local X=M and M[3]or 1.05;local Y=M and M[4]or 1.05;local Z=M and M[5]or 1.05;local _=M and M[6]or 0.95;local a0=M and M[7]or 1.05;local a1=M and M[8]or 0.97;H.power=o(H.power,1.2,O)H.speed=o(H.speed,X,O,true)H.maxacc=o(H.maxacc,1.05,O)H.maxdec=o(H.maxdec,1.05,O)H.turnrate=o(H.turnrate,1.05,O)H.sightdistance=o(H.sightdistance,1.05,O)H.radardistance=o(H.radardistance,1.1,O)H[R]=o(H[R],W,O,true)H.idleautoheal=o(H.idleautoheal,1.1,O)H.energymake=o(H.energymake,1.04,O)H.extractsmetal=o(H.extractsmetal,1.1,O)H.energyupkeep=o(H.energyupkeep,1.04,O)H.tidalgenerator=o(H.tidalgenerator,1.04,O)H.windgenerator=o(H.windgenerator,1.04,O)if H.windgenerator and not H.customparams.energymultiplier then H[P]=o(H[P],0.97,O,true)end;if H.tidalgenerator or H.windgenerator or H.builder==true or not H.speed and not H.weapondefs then H[P]=o(H[P],0.97,O,true)H[Q]=o(H[Q],0.98,O,true)H.buildtime=o(H.buildtime,0.98,O)H.workertime=o(H.workertime,1.05,O,true)H.builddistance=o(H.builddistance,1.05,O,true)else H[P]=o(H[P],1.035,O,true)H[Q]=o(H[Q],1.04,O,true)H.buildtime=o(H.buildtime,1.05,O)H.workertime=o(H.workertime,1.05,O,true)H.builddistance=o(H.builddistance,1.05,O,true)end;if H.customparams then H.customparams.energyconv_efficiency=o(H.customparams.energyconv_efficiency,1.04,O)H.customparams.energyconv_capacity=o(H.customparams.energyconv_capacity,1.04,O,true)H.customparams.shield_power=o(H.customparams.shield_power,1.1,O,true)H.customparams.shield_radius=o(H.customparams.shield_radius,1.05,O,true)H.customparams.energymultiplier=o(H.customparams.energymultiplier,1.04,O,true)end;if H.weapondefs then for T,U in pairs(H.weapondefs)do if U.interceptor==1 or U.targetable==1 then U.coverage=o(U.coverage,1.02,O,true)U.damage.default=o(U.damage.default,1.1,O)U.areaofeffect=o(U.areaofeffect,1.01,O)else if not U.reloadtime or U.reloadtime<0.034 then U.reloadtime=0.034 end;if U.burstrate and U.burstrate<0.034 then U.burstrate=0.034 end;if U.burst and U.burstrate then if U.burst*U.burstrate>U.reloadtime then U.reloadtime=U.burst*U.burstrate end end;if U.beamtime then if U.beamtime>U.reloadtime then U.reloadtime=U.beamtime end end;local a2=false;if U.burstrate and U.burst and U.reloadtime then local a3=U.burstrate*U.burst;local a4=a3/U.reloadtime;if a4>=0.98 or a3>=U.reloadtime then a2=true end end;local a5=false;if U.beamtime and U.reloadtime then if U.beamtime/U.reloadtime>=0.90 or U.beamtime>=U.reloadtime then a5=true end end;U.reloadtime=o(U.reloadtime,_,O)U.burstrate=o(U.burstrate,_,O)U.areaofeffect=o(U.areaofeffect,a0,O)U.weaponvelocity=o(U.weaponvelocity,1.06,O)U.range=o(U.range,Z,O,true)U.flighttime=o(U.flighttime,Z,O)U.sprayangle=o(U.sprayangle,a1,O)U.accuracy=o(U.accuracy,a1,O)if U.customparams then U.customparams.overrange_distance=o(U.customparams.overrange_distance,Z,O,true)U.customparams.controlradius=o(U.customparams.controlradius,Z,O,true)U.customparams.engagementrange=o(U.customparams.engagementrange,Z,O,true)end;if U.damage then local a6=1;local a7=0;local a8=U.reloadtime or 1;local a9=U.beamtime or 0;local aa=U.burstrate or 1;local ab=U.burst or 1;if a8<0.034 then a6=a6+0.034/a8-1;U.reloadtime=0.034;a8=0.034 end;local ac=U.customparams and U.customparams.sweepfire;if ac or G==\"armbeamer\"then U.reloadtime=U.reloadtime or a8;a8=U.reloadtime end;if a9>a8 then a6=a6+a9/a8-1;U.reloadtime=a9;a8=a9 end;if aa<0.034 then a6=a6+0.034/aa-1;U.burstrate=0.034;aa=0.034 end;local a3=aa*ab;if U.burstrate and U.burst and a3>a8 then a6=a6+a3/a8-1;U.reloadtime=a3 end;for u,V in pairs(U.damage)do if V==\"commanders\"then U.damage[u]=o(U.damage[u],1.02+a7,O,false,a6)else U.damage[u]=o(U.damage[u],Y+a7,O,false,a6)end end end;if U.shield then U.shield.power=o(U.shield.power,1.1,O,true)U.shield.powerregen=o(U.shield.powerregen,1.1,O,true)U.shield.radius=o(U.shield.radius,1.05,O,true)U.shield.force=o(U.shield.force,1.05,O)U.shield.powerregenenergy=o(U.shield.powerregenenergy,0.99,O,true)end;if a2==true then U.reloadtime=U.burst*U.burstrate end;if a5==true then U.reloadtime=U.beamtime end end end end;local ad=L[G]if ad then for u,V in pairs(ad[2])do H[u]=V end;local ae=ad[3]t(H,R,ae.hp,true)t(H,\"speed\",ae.spd,true)t(H,\"turnrate\",ae.turnrate)t(H,\"maxacc\",ae.maxacc)t(H,\"idleautoheal\",ae.autoheal)if H.customparams then t(H.customparams,\"shield_power\",ae.shield_power,true)t(H.customparams,\"shield_radius\",ae.shield_radius,true)end;if H.weapondefs then for af,ag in pairs(H.weapondefs)do if ag.interceptor~=1 and ag.targetable~=1 then t(ag,\"areaofeffect\",ae.aoe,true)t(ag,\"range\",ae.rng,true)t(ag,\"reloadtime\",ae.rld)t(ag,\"energypershot\",ae.energypershot)t(ag,\"sprayangle\",ae.acc)t(ag,\"accuracy\",ae.acc)if ae.dmg and ag.damage then for u,V in pairs(ag.damage)do ag.damage[u]=V*ae.dmg end end;if ae.impf then ag.impulsefactor=ae.impf end;if ae.impb then ag.impulseboost=ae.impb end;if ae.fs then ag.firestarter=ae.fs end;if ae.wob then ag.wobble=ae.wob end;if ae.dnc then ag.dance=ae.dnc end end end end end;if G then local ah=M and\" \"..M[1]or\"\"local ai=ad and\" \"..ad[1]or\"\"table.insert(rename_list,{G,\"prefix\",\"[\"..a[O]..ai..ah..\"]\"})table.insert(rename_list,{G,\"desc_prefix\",\"Mk.\"..O..\"   \"})end else if G then table.insert(rename_list,{G,\"prefix\",\"[Common]\"})table.insert(rename_list,{G,\"desc_prefix\",\"Mk.\"..O..\" \"})end end end;Spring.Echo(\"tweakdefs_rename_get_ready\")for aj,ak in pairs(rename_list)do Spring.Echo(\"/(\"..ak[1]..\"/-\"..ak[2]..\"/-\"..ak[3]..\"/)\")end;Spring.Echo(\"tweakdefs_rename_end\")"
  ],
  defaults: {
    rarity_chance: 0.7,
    MIN_FACTORY_RARITY: 7,
    CURSE_CHANCE: 0.1,
    TRAIT_CHANCE: 0.5,
    TRAIT_MIN_RARITY: 5
  },
  build: function(params) {
    var p = {};
    for (var k in this.defaults) p[k] = this.defaults[k];
    for (var k in params) p[k] = params[k];
    var body = this.segments[0] + p.rarity_chance
             + this.segments[1] + p.MIN_FACTORY_RARITY
             + this.segments[2] + p.CURSE_CHANCE
             + this.segments[3] + p.TRAIT_CHANCE
             + this.segments[4] + p.TRAIT_MIN_RARITY
             + this.segments[5];
    return Pipeline.build(this.header, body);
  }
};
