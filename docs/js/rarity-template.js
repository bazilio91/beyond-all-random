const RarityTemplate = {
  header: "--BaRandom v24 by LoH",
  segments: [
    "rename_list={}local a={\"Uncommon\",\"Rare\",\"Exceptional\",\"Epic\",\"Exotic\",\"Legendary\",\"Mythical\",\"Miracle\",\"Divine\",\"Eternal\",\"Supreme\",\"Omega\",\"Unique\",\"Jackpot\",\"Immortal\",\"Absurd\",\"Godlike\",\"TooRNG\",\"Insanely Lucky\",\"Dope\",\"Admin\",\"GOD\",\"ERROR\",\"Super Sayan\",\"Beyond\",\"MGGW\",\"AMBO\",\"Beyond All Reason\"}local b=",
    ";local c=",
    ";local d=",
    ";local e=",
    ";local f=",
    ";local g={",
    ",",
    ",",
    "}local h={",
    ",",
    ",",
    "}local i={cancloak=true,cloakcost=5,cloakcostmoving=15,mincloakdistance=75}local j={cancloak=true,cloakcost=5,cloakcostmoving=15,mincloakdistance=50}local k={[\"Glass Cannon\"]={{\"Phantom\",i,{hp=0.85}},{\"Volatile\",{},{dmg=1.3,hp=0.6}},{\"Overcharged\",{},{rld=0.8,energypershot=1.5}},{\"Plague\",{},{fs=1.0,aoe=1.15,dmg=0.9}},{\"Bouncer\",{},{impf=6.0,impb=2.0,dmg=0.6}}},[\"Tank\"]={{\"Juggernaut\",{},{hp=1.6,spd=0.7,turnrate=0.75}},{\"Regenerator\",{},{autoheal=3.0}},{\"Fortified\",{},{hp=1.3,rld=1.2}},{\"GravWell\",{},{impf=-2.0,aoe=1.4,dmg=0.8}}},[\"Sniper\"]={{\"Phantom\",i,{hp=0.9}},{\"Marksman\",{},{rng=1.3,acc=0.7,aoe=0.7}},{\"Piercing\",{},{dmg=1.2,aoe=0.5}},{\"Drunk\",{},{wob=4000,dnc=60,acc=2.5,aoe=1.3}}},[\"Brawler\"]={{\"Swift\",{},{spd=1.4,hp=0.7,maxacc=1.3}},{\"Berserker\",{},{dmg=1.2,aoe=1.3,acc=1.4}},{\"Siege\",{},{aoe=1.4,dmg=1.15,spd=0.85}},{\"Plague\",{},{fs=1.0,aoe=1.15,dmg=0.9}},{\"Bouncer\",{},{impf=6.0,impb=2.0,dmg=0.6}}},[\"Fortress\"]={{\"Juggernaut\",{},{hp=1.6}},{\"Shielded\",{},{shield_power=1.4,shield_radius=1.2}},{\"Siren\",{},{impf=3.5,impb=1.0,dmg=0.7,aoe=1.15}}},[\"Watchtower\"]={{\"Phantom\",j,{hp=0.9}},{\"Marksman\",{},{rng=1.3,acc=0.7,aoe=0.7}},{\"GravWell\",{},{impf=-2.0,aoe=1.4,dmg=0.8}}},[\"Suppressor\"]={{\"Siege\",{},{aoe=1.4,dmg=1.15,acc=1.3}},{\"Berserker\",{},{dmg=1.3,aoe=1.3}},{\"Siren\",{},{impf=3.5,impb=1.0,dmg=0.7,aoe=1.15}},{\"Drunk\",{},{wob=4000,dnc=60,acc=2.5,aoe=1.3}}}}local function l(m)local m=m or 0;if m+1<=#a and math.random()<b then m=l(m+1)end;return m end;local function n(o)local p=l(o)if p<o then p=o end;return p end;local function q(m,r,p,s,t)m=tonumber(m)if m then local u=m*r^p+(r-1)*m;if m>0 and u<=0 then u=m*r^p end;if s then u=math.floor(u)end;return u*(t or 1)end end;local function v(u,w,r,p,s)u[w]=q(u[w],r,p,s)end;local function x(u,w,r,s)local y=tonumber(u[w])if r and y then u[w]=y*r;if s then u[w]=math.floor(u[w])end end end;local function z(A)return A:byte()==99 and 2 or A:byte()==108 and 3 or 1 end;local B={{\"Glass Cannon\",0.88,1.05,1.12,1.05,0.91,1.05,0.96},{\"Tank\",1.22,1.0,1.01,1.04,0.97,1.04,0.97},{\"Sniper\",1.03,1.04,1.07,1.14,0.98,0.95,0.91},{\"Brawler\",1.06,1.10,1.05,1.0,0.88,1.10,0.97}}local C={{\"Fortress\",1.20,1.0,1.08,1.04,0.97,1.04,0.97},{\"Watchtower\",1.03,1.0,1.05,1.14,0.98,0.95,0.91},{\"Suppressor\",1.06,1.0,1.04,1.0,0.88,1.12,0.97}}local D={{\"armthund\",\"armkam\"},{\"armpw\",\"armrock\",\"armham\",\"armwar\",\"armflea\"},{\"armmlv\",\"armfav\",\"armflash\",\"armpincer\",\"armstump\",\"armart\",\"armjanus\"},{\"armdecade\",\"armpt\",\"armpship\",\"armroy\",\"armsub\"},{\"armsh\",\"armanac\",\"armmh\"},{\"armsaber\",\"armsb\",\"armseap\"},{\"armbrawl\",\"armpnix\",\"armlance\",\"armdfly\",\"armblade\",\"armstil\",\"armliche\"},{\"armfast\",\"armamph\",\"armzeus\",\"armmav\",\"armsptk\",\"armfido\",\"armsnipe\",\"armfboy\",\"armspid\",\"armvader\",\"armscab\"},{\"armcroc\",\"armlatnk\",\"armbull\",\"armgremlin\",\"armmart\",\"armmerl\",\"armmanni\"},{\"armcrus\",\"armsubk\",\"armserp\",\"armantiship\",\"armbats\",\"armmship\",\"armepoch\",\"armlship\"},{\"armbanth\",\"armraz\",\"armmar\",\"armvang\",\"armlun\",\"armthor\"},{\"corshad\",\"corbw\"},{\"corak\",\"corstorm\",\"corthud\"},{\"cormlv\",\"corfav\",\"corgator\",\"corgarp\",\"corraid\",\"corlevlr\",\"corwolv\"},{\"coresupp\",\"corpt\",\"corpship\",\"corroy\",\"corsub\"},{\"corsh\",\"corsnap\",\"cormh\",\"corhal\"},{\"corcut\",\"corsb\",\"corseap\"},{\"corape\",\"corhurc\",\"cortitan\",\"corcrwh\"},{\"corpyro\",\"coramph\",\"corcan\",\"corsumo\",\"cortermite\",\"cormort\",\"corhrk\",\"corroach\",\"corsktl\",\"cormando\"},{\"corsala\",\"correap\",\"corparrow\",\"corgol\",\"corban\",\"cormart\",\"corvroc\",\"cortrem\"},{\"corcrus\",\"corshark\",\"corssub\",\"corantiship\",\"corbats\",\"cormship\",\"corblackhy\",\"corfship\"},{\"corkorg\",\"corkarg\",\"corjugg\",\"corshiva\",\"corcat\",\"corsok\",\"cordemon\"},{\"legkam\",\"legcib\",\"legmos\"},{\"leggob\",\"leglob\",\"legcen\",\"legbal\",\"legkark\"},{\"legscout\",\"leghades\",\"leghelios\",\"leggat\",\"legbar\",\"legmlv\",\"legamphtank\"},{\"legnavyscout\",\"legnavyfrigate\",\"legnavydestro\",\"legnavysub\",\"legnavyartyship\"},{\"legsh\",\"legner\",\"legmh\",\"legcar\"},{\"legspsurfacegunship\",\"legspcarrier\",\"legspbomber\",\"legsptorpgunship\"},{\"legstronghold\",\"legmineb\",\"legatorpbomber\",\"legfort\",\"legphoenix\"},{\"legstr\",\"legamph\",\"legshot\",\"leginc\",\"legsrail\",\"legbart\",\"leginfestor\",\"leghrk\",\"legsnapper\"},{\"legmrv\",\"legaskirmtank\",\"legfloat\",\"legaheattank\",\"legmed\",\"legamcluster\",\"legvcarry\",\"legavroc\",\"leginf\"},{\"leganavycruiser\",\"leganavyheavysub\",\"leganavybattlesub\",\"leganavybattleship\",\"leganavyartyship\",\"leganavymissileship\",\"leganavyflagship\",\"leganavyantiswarm\"},{\"legeheatraymech\",\"legeallterrainmech\",\"legjav\",\"legelrpcmech\",\"legehovertank\",\"legerailtank\",\"legeshotgunmech\",\"legkeres\"}}local E={}local F={}for G,H in ipairs(D)do local I={}for G,J in ipairs(H)do if not F[J]then I[#I+1]=J end end;if#I==0 then I=H end;local K=I[math.random(#I)]local L=z(K)local p=n(math.max(c,g[L]))if p>h[L]then p=h[L]end;E[K]=p;F[K]=true end;local M={}for N,O in pairs(UnitDefs)do if not E[N]then local P=O.weapondefs and O.builder~=true;if P and math.random()<d then local Q=l()if Q<1 then Q=1 end;M[N]=Q;E[N]=0 else local p=l()local L=z(N)if p<g[L]then p=g[L]end;if p>h[L]then p=h[L]end;E[N]=p end end end;local R={}for N,O in pairs(UnitDefs)do local p=E[N]or 0;if p>=5 and O.weapondefs then if O.speed then R[N]=B[math.random(#B)]elseif O.builder~=true then R[N]=C[math.random(#C)]end end end;local S={}for N,O in pairs(UnitDefs)do local p=E[N]or 0;local T=R[N]if p>=f and T then local U=k[T[1]]if U and math.random()<e then S[N]=U[math.random(#U)]end end end;for N,O in pairs(UnitDefs)do local V=E[N]or 0;local W=O.metalcost and\"metalcost\"or\"buildcostmetal\"local X=O.energycost and\"energycost\"or\"buildcostenergy\"local Y=O.health and\"health\"or\"maxdamage\"if not O.power then O.power=O[W]+O[X]/60 end;local Z=O.customparams;local _=V;if not(V<=#a)then V=#a end;if not(V<=6)and(N==\"armcom\"or N==\"corcom\"or N==\"legcom\")then V=6 end;local Q=M[N]if Q then if Z then Z.cursed=tostring(Q)end;v(O,Y,0.93,Q,true)v(O,\"speed\",0.97,Q,true)v(O,\"maxacc\",0.97,Q)v(O,\"turnrate\",0.97,Q)v(O,\"sightdistance\",0.97,Q)v(O,\"radardistance\",0.97,Q)v(O,W,0.85,Q,true)v(O,X,0.85,Q,true)v(O,\"buildtime\",0.88,Q)if O.weapondefs then for G,a0 in pairs(O.weapondefs)do if a0.interceptor~=1 and a0.targetable~=1 then v(a0,\"range\",0.97,Q,true)v(a0,\"reloadtime\",1.04,Q)if a0.damage then for w,y in pairs(a0.damage)do a0.damage[w]=q(y,0.94,Q)end end end end end;if N then table.insert(rename_list,{N,\"prefix\",\"[Cursed Mk.\"..Q..\"]\"})table.insert(rename_list,{N,\"desc_prefix\",\"Cursed Mk.\"..Q..\" \"})end elseif _>0 then if Z then Z.rarity=tostring(V)end;local T=R[N]local a1=T and T[2]or 1.1;local a2=T and T[3]or 1.05;local a3=T and T[4]or 1.05;local a4=T and T[5]or 1.05;local a5=T and T[6]or 0.95;local a6=T and T[7]or 1.05;local a7=T and T[8]or 0.97;local a8=V;v(O,\"power\",1.2,a8)v(O,\"speed\",a2,a8,true)v(O,\"maxacc\",1.05,a8)v(O,\"maxdec\",1.05,a8)v(O,\"turnrate\",1.05,a8)v(O,\"sightdistance\",1.05,a8)v(O,\"radardistance\",1.1,a8)v(O,Y,a1,a8,true)v(O,\"idleautoheal\",1.1,a8)v(O,\"energymake\",1.04,a8)v(O,\"extractsmetal\",1.1,a8)v(O,\"energyupkeep\",1.04,a8)v(O,\"tidalgenerator\",1.04,a8)v(O,\"windgenerator\",1.04,a8)if O.windgenerator and not Z.energymultiplier then v(O,W,0.97,a8,true)end;if O.tidalgenerator or O.windgenerator or O.builder==true or not O.speed and not O.weapondefs then v(O,W,0.97,a8,true)v(O,X,0.98,a8,true)v(O,\"buildtime\",0.98,a8)v(O,\"workertime\",1.05,a8,true)v(O,\"builddistance\",1.05,a8,true)else v(O,W,1.035,a8,true)v(O,X,1.04,a8,true)v(O,\"buildtime\",1.05,a8)v(O,\"workertime\",1.05,a8,true)v(O,\"builddistance\",1.05,a8,true)end;if Z then v(Z,\"energyconv_efficiency\",1.04,a8)v(Z,\"energyconv_capacity\",1.04,a8,true)v(Z,\"shield_power\",1.1,a8,true)v(Z,\"shield_radius\",1.05,a8,true)v(Z,\"energymultiplier\",1.04,a8,true)end;if O.weapondefs then for G,a0 in pairs(O.weapondefs)do if a0.interceptor==1 or a0.targetable==1 then v(a0,\"coverage\",1.02,a8,true)v(a0.damage,\"default\",1.1,a8)v(a0,\"areaofeffect\",1.01,a8)else local a9=a0.customparams;if not a0.reloadtime or a0.reloadtime<0.034 then a0.reloadtime=0.034 end;if a0.burstrate and a0.burstrate<0.034 then a0.burstrate=0.034 end;if a0.burst and a0.burstrate then if a0.burst*a0.burstrate>a0.reloadtime then a0.reloadtime=a0.burst*a0.burstrate end end;if a0.beamtime then if a0.beamtime>a0.reloadtime then a0.reloadtime=a0.beamtime end end;local aa=false;if a0.burstrate and a0.burst and a0.reloadtime then local ab=a0.burstrate*a0.burst;if ab/a0.reloadtime>=0.98 or ab>=a0.reloadtime then aa=true end end;local ac=false;if a0.beamtime and a0.reloadtime then if a0.beamtime/a0.reloadtime>=0.90 or a0.beamtime>=a0.reloadtime then ac=true end end;v(a0,\"reloadtime\",a5,a8)v(a0,\"burstrate\",a5,a8)v(a0,\"areaofeffect\",a6,a8)v(a0,\"weaponvelocity\",1.05,a8)v(a0,\"range\",a4,a8,true)v(a0,\"flighttime\",1.05,a8)v(a0,\"sprayangle\",a7,a8)v(a0,\"accuracy\",a7,a8)v(a0,\"energypershot\",1.1,a8,true)v(a0,\"metalpershot\",1.05,a8,true)v(a0,\"stockpiletime\",0.96,a8,true)v(a0,\"startvelocity\",1.05,a8)v(a0,\"turnrate\",1.03,a8)v(a0,\"weaponacceleration\",1.05,a8)v(a0,\"laserflaresize\",1.04,a8)v(a0,\"size\",1.09,a8)v(a0,\"thickness\",1.06,a8)if a9 then v(a9,\"overrange_distance\",a4,a8,true)v(a9,\"controlradius\",a4,a8,true)v(a9,\"engagementrange\",a4,a8,true)local ad=tonumber(a9.spark_range)if ad then a9.spark_range=tostring(q(ad,1.05,a8,true))end;v(a9,\"area_onhit_damage\",1.05,a8,true)v(a9,\"area_onhit_range\",1.05,a8,true)end;if a0.damage then local ae=1;local af=0;local ag=a0.reloadtime or 1;local ah=a0.beamtime or 0;local ai=a0.burstrate or 1;local aj=a0.burst or 1;if ag<0.034 then ae=ae+0.034/ag-1;a0.reloadtime=0.034;ag=0.034 end;local ak=a9 and a9.sweepfire;if ak or N==\"armbeamer\"then a0.reloadtime=a0.reloadtime or ag;ag=a0.reloadtime end;if ah>ag then ae=ae+ah/ag-1;a0.reloadtime=ah;ag=ah end;if ai<0.034 then ae=ae+0.034/ai-1;a0.burstrate=0.034;ai=0.034 end;local ab=ai*aj;if a0.burstrate and a0.burst and ab>ag then ae=ae+ab/ag-1;a0.reloadtime=ab end;for w,y in pairs(a0.damage)do if y==\"commanders\"then a0.damage[w]=q(y,1.02+af,a8,false,ae)else a0.damage[w]=q(y,a3+af,a8,false,ae)end end end;local al=a0.shield;if al then v(al,\"power\",1.1,a8,true)v(al,\"powerregen\",1.1,a8,true)v(al,\"radius\",1.05,a8,true)v(al,\"force\",1.05,a8)v(al,\"powerregenenergy\",0.99,a8,true)end;if aa then a0.reloadtime=a0.burst*a0.burstrate end;if ac then a0.reloadtime=a0.beamtime end end end end;local am=S[N]if am then for w,y in pairs(am[2])do O[w]=y end;local an=am[3]x(O,Y,an.hp,true)x(O,\"speed\",an.spd,true)x(O,\"turnrate\",an.turnrate)x(O,\"maxacc\",an.maxacc)x(O,\"idleautoheal\",an.autoheal)if Z then x(Z,\"shield_power\",an.shield_power,true)x(Z,\"shield_radius\",an.shield_radius,true)end;if O.weapondefs then for ao,a0 in pairs(O.weapondefs)do if a0.interceptor~=1 and a0.targetable~=1 then x(a0,\"areaofeffect\",an.aoe,true)x(a0,\"range\",an.rng,true)x(a0,\"reloadtime\",an.rld)x(a0,\"energypershot\",an.energypershot)x(a0,\"sprayangle\",an.acc)x(a0,\"accuracy\",an.acc)if an.dmg and a0.damage then for w,y in pairs(a0.damage)do a0.damage[w]=y*an.dmg end end;if an.impf then a0.impulsefactor=an.impf end;if an.impb then a0.impulseboost=an.impb end;if an.fs then a0.firestarter=an.fs end;if an.wob then a0.wobble=an.wob end;if an.dnc then a0.dance=an.dnc end end end end end;if N then local ap=T and\" \"..T[1]or\"\"local aq=am and\" \"..am[1]or\"\"table.insert(rename_list,{N,\"prefix\",\"[\"..a[V]..aq..ap..\"]\"})table.insert(rename_list,{N,\"desc_prefix\",\"Mk.\"..V..\"   \"})end else if N then table.insert(rename_list,{N,\"prefix\",\"[Common]\"})table.insert(rename_list,{N,\"desc_prefix\",\"Mk.\"..V..\" \"})end end end;Spring.Echo(\"tweakdefs_rename_get_ready\")for ar,as in pairs(rename_list)do Spring.Echo(\"/(\"..as[1]..\"/-\"..as[2]..\"/-\"..as[3]..\"/)\")end;Spring.Echo(\"tweakdefs_rename_end\")"
  ],
  defaults: {
    rarity_chance: 0.7,
    MIN_FACTORY_RARITY: 7,
    CURSE_CHANCE: 0.1,
    TRAIT_CHANCE: 0.5,
    TRAIT_MIN_RARITY: 5,
    arm_floor: 0,
    cor_floor: 0,
    leg_floor: 0,
    arm_ceil: 28,
    cor_ceil: 28,
    leg_ceil: 28
  },
  build: function(params) {
    var p = {};
    for (var k in this.defaults) p[k] = this.defaults[k];
    for (var k in params) p[k] = params[k];
    var body = this.segments[0] + p.rarity_chance
             + this.segments[1] + p.MIN_FACTORY_RARITY
             + this.segments[2] + p.CURSE_CHANCE
             + this.segments[3] + p.TRAIT_CHANCE
             + this.segments[4] + p.TRAIT_MIN_RARITY
             + this.segments[5] + p.arm_floor
             + this.segments[6] + p.cor_floor
             + this.segments[7] + p.leg_floor
             + this.segments[8] + p.arm_ceil
             + this.segments[9] + p.cor_ceil
             + this.segments[10] + p.leg_ceil
             + this.segments[11];
    return Pipeline.build(this.header, body);
  }
};
