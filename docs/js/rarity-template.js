const RarityTemplate = {
  header: "--BaRandom v21 by LoH\n--Use with: !bset tweakdefs0 <mod.b64>",
  segments: [
    "rename_list={}local a={\"Uncommon\",\"Rare\",\"Exceptional\",\"Epic\",\"Exotic\",\"Legendary\",\"Mythical\",\"Miracle\",\"Divine\",\"Eternal\",\"Supreme\",\"Omega\",\"Unique\",\"Jackpot\",\"Immortal\",\"Absurd\",\"Godlike\",\"TooRNG\",\"Insanely Lucky\",\"Dope\",\"Admin\",\"GOD\",\"ERROR\",\"Super Sayan\",\"Beyond\",\"MGGW\",\"AMBO\",\"Beyond All Reason\"}local b=",
    ";local c=",
    ";local d=",
    ";local e=",
    ";local f=",
    ";local g={",
    ",",
    ",",
    "}local h={",
    ",",
    ",",
    "}local i={cancloak=true,cloakcost=5,cloakcostmoving=15,mincloakdistance=75}local j={cancloak=true,cloakcost=5,cloakcostmoving=15,mincloakdistance=50}local k={[\"Glass Cannon\"]={{\"Phantom\",i,{hp=0.85}},{\"Volatile\",{},{dmg=1.3,hp=0.6}},{\"Overcharged\",{},{rld=0.8,energypershot=1.5}},{\"Plague\",{},{fs=1.0,aoe=1.15,dmg=0.9}},{\"Bouncer\",{},{impf=6.0,impb=2.0,dmg=0.6}}},[\"Tank\"]={{\"Juggernaut\",{},{hp=1.6,spd=0.7,turnrate=0.75}},{\"Regenerator\",{},{autoheal=3.0}},{\"Fortified\",{},{hp=1.3,rld=1.2}},{\"GravWell\",{},{impf=-2.0,aoe=1.4,dmg=0.8}}},[\"Sniper\"]={{\"Phantom\",i,{hp=0.9}},{\"Marksman\",{},{rng=1.3,acc=0.7,aoe=0.7}},{\"Piercing\",{},{dmg=1.2,aoe=0.5}},{\"Drunk\",{},{wob=4000,dnc=60,acc=2.5,aoe=1.3}}},[\"Brawler\"]={{\"Swift\",{},{spd=1.4,hp=0.7,maxacc=1.3}},{\"Berserker\",{},{dmg=1.2,aoe=1.3,acc=1.4}},{\"Siege\",{},{aoe=1.4,dmg=1.15,spd=0.85}},{\"Plague\",{},{fs=1.0,aoe=1.15,dmg=0.9}},{\"Bouncer\",{},{impf=6.0,impb=2.0,dmg=0.6}}},[\"Fortress\"]={{\"Juggernaut\",{},{hp=1.6}},{\"Shielded\",{},{shield_power=1.4,shield_radius=1.2}},{\"Siren\",{},{impf=3.5,impb=1.0,dmg=0.7,aoe=1.15}}},[\"Watchtower\"]={{\"Phantom\",j,{hp=0.9}},{\"Marksman\",{},{rng=1.3,acc=0.7,aoe=0.7}},{\"GravWell\",{},{impf=-2.0,aoe=1.4,dmg=0.8}}},[\"Suppressor\"]={{\"Siege\",{},{aoe=1.4,dmg=1.15,acc=1.3}},{\"Berserker\",{},{dmg=1.3,aoe=1.3}},{\"Siren\",{},{impf=3.5,impb=1.0,dmg=0.7,aoe=1.15}},{\"Drunk\",{},{wob=4000,dnc=60,acc=2.5,aoe=1.3}}}}local function l(m)local m=m or 0;if m+1<=#a and math.random()<b then m=l(m+1)end;return m end;local function n(o)local p=l(o)if p<o then p=o end;return p end;local function q(m,r,p,s,t)if m then local u=m*r^p+(r-1)*m;if m>0 and u<=0 then u=m*r^p end;if s then u=math.floor(u)end;return u*(t or 1)end end;local function v(u,w,r,s)if r and u[w]then u[w]=u[w]*r;if s then u[w]=math.floor(u[w])end end end;local function x(y)return y:byte()==99 and 2 or y:byte()==108 and 3 or 1 end;local z={{\"Glass Cannon\",0.88,1.05,1.12,1.05,0.91,1.05,0.96},{\"Tank\",1.22,1.0,1.01,1.04,0.97,1.04,0.97},{\"Sniper\",1.03,1.04,1.07,1.14,0.98,0.95,0.91},{\"Brawler\",1.06,1.10,1.05,1.0,0.88,1.10,0.97}}local A={{\"Fortress\",1.20,1.0,1.08,1.04,0.97,1.04,0.97},{\"Watchtower\",1.03,1.0,1.05,1.14,0.98,0.95,0.91},{\"Suppressor\",1.06,1.0,1.04,1.0,0.88,1.12,0.97}}local B={{\"armthund\",\"armkam\"},{\"armpw\",\"armrock\",\"armham\",\"armwar\",\"armflea\"},{\"armmlv\",\"armfav\",\"armflash\",\"armpincer\",\"armstump\",\"armart\",\"armjanus\"},{\"armdecade\",\"armpt\",\"armpship\",\"armroy\",\"armsub\"},{\"armsh\",\"armanac\",\"armmh\"},{\"armsaber\",\"armsb\",\"armseap\"},{\"armbrawl\",\"armpnix\",\"armlance\",\"armdfly\",\"armblade\",\"armstil\",\"armliche\"},{\"armfast\",\"armamph\",\"armzeus\",\"armmav\",\"armsptk\",\"armfido\",\"armsnipe\",\"armfboy\",\"armspid\",\"armvader\",\"armscab\"},{\"armcroc\",\"armlatnk\",\"armbull\",\"armgremlin\",\"armmart\",\"armmerl\",\"armmanni\"},{\"armcrus\",\"armsubk\",\"armserp\",\"armantiship\",\"armbats\",\"armmship\",\"armepoch\",\"armlship\"},{\"armbanth\",\"armraz\",\"armmar\",\"armvang\",\"armlun\",\"armthor\"},{\"corshad\",\"corbw\"},{\"corak\",\"corstorm\",\"corthud\"},{\"cormlv\",\"corfav\",\"corgator\",\"corgarp\",\"corraid\",\"corlevlr\",\"corwolv\"},{\"coresupp\",\"corpt\",\"corpship\",\"corroy\",\"corsub\"},{\"corsh\",\"corsnap\",\"cormh\",\"corhal\"},{\"corcut\",\"corsb\",\"corseap\"},{\"corape\",\"corhurc\",\"cortitan\",\"corcrwh\"},{\"corpyro\",\"coramph\",\"corcan\",\"corsumo\",\"cortermite\",\"cormort\",\"corhrk\",\"corroach\",\"corsktl\",\"cormando\"},{\"corsala\",\"correap\",\"corparrow\",\"corgol\",\"corban\",\"cormart\",\"corvroc\",\"cortrem\"},{\"corcrus\",\"corshark\",\"corssub\",\"corantiship\",\"corbats\",\"cormship\",\"corblackhy\",\"corfship\"},{\"corkorg\",\"corkarg\",\"corjugg\",\"corshiva\",\"corcat\",\"corsok\",\"cordemon\"},{\"legkam\",\"legcib\",\"legmos\"},{\"leggob\",\"leglob\",\"legcen\",\"legbal\",\"legkark\"},{\"legscout\",\"leghades\",\"leghelios\",\"leggat\",\"legbar\",\"legmlv\",\"legamphtank\"},{\"legnavyscout\",\"legnavyfrigate\",\"legnavydestro\",\"legnavysub\",\"legnavyartyship\"},{\"legsh\",\"legner\",\"legmh\",\"legcar\"},{\"legspsurfacegunship\",\"legspcarrier\",\"legspbomber\",\"legsptorpgunship\"},{\"legstronghold\",\"legmineb\",\"legatorpbomber\",\"legfort\",\"legphoenix\"},{\"legstr\",\"legamph\",\"legshot\",\"leginc\",\"legsrail\",\"legbart\",\"leginfestor\",\"leghrk\",\"legsnapper\"},{\"legmrv\",\"legaskirmtank\",\"legfloat\",\"legaheattank\",\"legmed\",\"legamcluster\",\"legvcarry\",\"legavroc\",\"leginf\"},{\"leganavycruiser\",\"leganavyheavysub\",\"leganavybattlesub\",\"leganavybattleship\",\"leganavyartyship\",\"leganavymissileship\",\"leganavyflagship\",\"leganavyantiswarm\"},{\"legeheatraymech\",\"legeallterrainmech\",\"legjav\",\"legelrpcmech\",\"legehovertank\",\"legerailtank\",\"legeshotgunmech\",\"legkeres\"}}local C={}local D={}for E,F in ipairs(B)do local G={}for E,H in ipairs(F)do if not D[H]then G[#G+1]=H end end;if#G==0 then G=F end;local I=G[math.random(#G)]local J=x(I)local p=n(math.max(c,g[J]))if p>h[J]then p=h[J]end;C[I]=p;D[I]=true end;local K={}for L,M in pairs(UnitDefs)do if not C[L]then local N=M.weapondefs and M.builder~=true;if N and math.random()<d then local O=l()if O<1 then O=1 end;K[L]=O;C[L]=0 else local p=l()local J=x(L)if p<g[J]then p=g[J]end;if p>h[J]then p=h[J]end;C[L]=p end end end;local P={}for L,M in pairs(UnitDefs)do local p=C[L]or 0;if p>=5 and M.weapondefs then if M.speed then P[L]=z[math.random(#z)]elseif M.builder~=true then P[L]=A[math.random(#A)]end end end;local Q={}for L,M in pairs(UnitDefs)do local p=C[L]or 0;local R=P[L]if p>=f and R then local S=k[R[1]]if S and math.random()<e then Q[L]=S[math.random(#S)]end end end;for L,M in pairs(UnitDefs)do local T=C[L]or 0;local U=M.metalcost and\"metalcost\"or\"buildcostmetal\"local V=M.energycost and\"energycost\"or\"buildcostenergy\"local W=M.health and\"health\"or\"maxdamage\"if not M.power then M.power=M[U]+M[V]/60 end;local X=M.customparams;local Y=T;if not(T<=#a)then T=#a end;if not(T<=6)and(L==\"armcom\"or L==\"corcom\"or L==\"legcom\")then T=6 end;local O=K[L]if O then if X then X.cursed=tostring(O)end;M[W]=q(M[W],0.93,O,true)M.speed=q(M.speed,0.97,O,true)M.maxacc=q(M.maxacc,0.97,O)M.turnrate=q(M.turnrate,0.97,O)M.sightdistance=q(M.sightdistance,0.97,O)M.radardistance=q(M.radardistance,0.97,O)M[U]=q(M[U],0.85,O,true)M[V]=q(M[V],0.85,O,true)M.buildtime=q(M.buildtime,0.88,O)if M.weapondefs then for Z,_ in pairs(M.weapondefs)do if _.interceptor~=1 and _.targetable~=1 then _.range=q(_.range,0.97,O,true)_.reloadtime=q(_.reloadtime,1.04,O)if _.damage then for w,a0 in pairs(_.damage)do _.damage[w]=q(_.damage[w],0.94,O)end end end end end;if L then table.insert(rename_list,{L,\"prefix\",\"[Cursed Mk.\"..O..\"]\"})table.insert(rename_list,{L,\"desc_prefix\",\"Cursed Mk.\"..O..\" \"})end elseif Y>0 then if X then X.rarity=tostring(T)end;local R=P[L]local a1=R and R[2]or 1.1;local a2=R and R[3]or 1.05;local a3=R and R[4]or 1.05;local a4=R and R[5]or 1.05;local a5=R and R[6]or 0.95;local a6=R and R[7]or 1.05;local a7=R and R[8]or 0.97;M.power=q(M.power,1.2,T)M.speed=q(M.speed,a2,T,true)M.maxacc=q(M.maxacc,1.05,T)M.maxdec=q(M.maxdec,1.05,T)M.turnrate=q(M.turnrate,1.05,T)M.sightdistance=q(M.sightdistance,1.05,T)M.radardistance=q(M.radardistance,1.1,T)M[W]=q(M[W],a1,T,true)M.idleautoheal=q(M.idleautoheal,1.1,T)M.energymake=q(M.energymake,1.04,T)M.extractsmetal=q(M.extractsmetal,1.1,T)M.energyupkeep=q(M.energyupkeep,1.04,T)M.tidalgenerator=q(M.tidalgenerator,1.04,T)M.windgenerator=q(M.windgenerator,1.04,T)if M.windgenerator and not X.energymultiplier then M[U]=q(M[U],0.97,T,true)end;if M.tidalgenerator or M.windgenerator or M.builder==true or not M.speed and not M.weapondefs then M[U]=q(M[U],0.97,T,true)M[V]=q(M[V],0.98,T,true)M.buildtime=q(M.buildtime,0.98,T)M.workertime=q(M.workertime,1.05,T,true)M.builddistance=q(M.builddistance,1.05,T,true)else M[U]=q(M[U],1.035,T,true)M[V]=q(M[V],1.04,T,true)M.buildtime=q(M.buildtime,1.05,T)M.workertime=q(M.workertime,1.05,T,true)M.builddistance=q(M.builddistance,1.05,T,true)end;if X then X.energyconv_efficiency=q(X.energyconv_efficiency,1.04,T)X.energyconv_capacity=q(X.energyconv_capacity,1.04,T,true)X.shield_power=q(X.shield_power,1.1,T,true)X.shield_radius=q(X.shield_radius,1.05,T,true)X.energymultiplier=q(X.energymultiplier,1.04,T,true)end;if M.weapondefs then for Z,_ in pairs(M.weapondefs)do if _.interceptor==1 or _.targetable==1 then _.coverage=q(_.coverage,1.02,T,true)_.damage.default=q(_.damage.default,1.1,T)_.areaofeffect=q(_.areaofeffect,1.01,T)else local a8=_.customparams;if not _.reloadtime or _.reloadtime<0.034 then _.reloadtime=0.034 end;if _.burstrate and _.burstrate<0.034 then _.burstrate=0.034 end;if _.burst and _.burstrate then if _.burst*_.burstrate>_.reloadtime then _.reloadtime=_.burst*_.burstrate end end;if _.beamtime then if _.beamtime>_.reloadtime then _.reloadtime=_.beamtime end end;local a9=false;if _.burstrate and _.burst and _.reloadtime then local aa=_.burstrate*_.burst;local ab=aa/_.reloadtime;if ab>=0.98 or aa>=_.reloadtime then a9=true end end;local ac=false;if _.beamtime and _.reloadtime then if _.beamtime/_.reloadtime>=0.90 or _.beamtime>=_.reloadtime then ac=true end end;_.reloadtime=q(_.reloadtime,a5,T)_.burstrate=q(_.burstrate,a5,T)_.areaofeffect=q(_.areaofeffect,a6,T)_.weaponvelocity=q(_.weaponvelocity,1.06,T)_.range=q(_.range,a4,T,true)_.flighttime=q(_.flighttime,a4,T)_.sprayangle=q(_.sprayangle,a7,T)_.accuracy=q(_.accuracy,a7,T)if a8 then a8.overrange_distance=q(a8.overrange_distance,a4,T,true)a8.controlradius=q(a8.controlradius,a4,T,true)a8.engagementrange=q(a8.engagementrange,a4,T,true)end;if _.damage then local ad=1;local ae=0;local af=_.reloadtime or 1;local ag=_.beamtime or 0;local ah=_.burstrate or 1;local ai=_.burst or 1;if af<0.034 then ad=ad+0.034/af-1;_.reloadtime=0.034;af=0.034 end;local aj=a8 and a8.sweepfire;if aj or L==\"armbeamer\"then _.reloadtime=_.reloadtime or af;af=_.reloadtime end;if ag>af then ad=ad+ag/af-1;_.reloadtime=ag;af=ag end;if ah<0.034 then ad=ad+0.034/ah-1;_.burstrate=0.034;ah=0.034 end;local aa=ah*ai;if _.burstrate and _.burst and aa>af then ad=ad+aa/af-1;_.reloadtime=aa end;for w,a0 in pairs(_.damage)do if a0==\"commanders\"then _.damage[w]=q(_.damage[w],1.02+ae,T,false,ad)else _.damage[w]=q(_.damage[w],a3+ae,T,false,ad)end end end;if _.shield then _.shield.power=q(_.shield.power,1.1,T,true)_.shield.powerregen=q(_.shield.powerregen,1.1,T,true)_.shield.radius=q(_.shield.radius,1.05,T,true)_.shield.force=q(_.shield.force,1.05,T)_.shield.powerregenenergy=q(_.shield.powerregenenergy,0.99,T,true)end;if a9==true then _.reloadtime=_.burst*_.burstrate end;if ac==true then _.reloadtime=_.beamtime end end end end;local ak=Q[L]if ak then for w,a0 in pairs(ak[2])do M[w]=a0 end;local al=ak[3]v(M,W,al.hp,true)v(M,\"speed\",al.spd,true)v(M,\"turnrate\",al.turnrate)v(M,\"maxacc\",al.maxacc)v(M,\"idleautoheal\",al.autoheal)if X then v(X,\"shield_power\",al.shield_power,true)v(X,\"shield_radius\",al.shield_radius,true)end;if M.weapondefs then for am,an in pairs(M.weapondefs)do if an.interceptor~=1 and an.targetable~=1 then v(an,\"areaofeffect\",al.aoe,true)v(an,\"range\",al.rng,true)v(an,\"reloadtime\",al.rld)v(an,\"energypershot\",al.energypershot)v(an,\"sprayangle\",al.acc)v(an,\"accuracy\",al.acc)if al.dmg and an.damage then for w,a0 in pairs(an.damage)do an.damage[w]=a0*al.dmg end end;if al.impf then an.impulsefactor=al.impf end;if al.impb then an.impulseboost=al.impb end;if al.fs then an.firestarter=al.fs end;if al.wob then an.wobble=al.wob end;if al.dnc then an.dance=al.dnc end end end end end;if L then local ao=R and\" \"..R[1]or\"\"local ap=ak and\" \"..ak[1]or\"\"table.insert(rename_list,{L,\"prefix\",\"[\"..a[T]..ap..ao..\"]\"})table.insert(rename_list,{L,\"desc_prefix\",\"Mk.\"..T..\"   \"})end else if L then table.insert(rename_list,{L,\"prefix\",\"[Common]\"})table.insert(rename_list,{L,\"desc_prefix\",\"Mk.\"..T..\" \"})end end end;Spring.Echo(\"tweakdefs_rename_get_ready\")for aq,ar in pairs(rename_list)do Spring.Echo(\"/(\"..ar[1]..\"/-\"..ar[2]..\"/-\"..ar[3]..\"/)\")end;Spring.Echo(\"tweakdefs_rename_end\")"
  ],
  defaults: {
    rarity_chance: 0.7,
    MIN_FACTORY_RARITY: 7,
    CURSE_CHANCE: 0.1,
    TRAIT_CHANCE: 0.5,
    TRAIT_MIN_RARITY: 5,
    arm_floor: 0,
    cor_floor: 0,
    leg_floor: 0,
    arm_ceil: 28,
    cor_ceil: 28,
    leg_ceil: 28
  },
  build: function(params) {
    var p = {};
    for (var k in this.defaults) p[k] = this.defaults[k];
    for (var k in params) p[k] = params[k];
    var body = this.segments[0] + p.rarity_chance
             + this.segments[1] + p.MIN_FACTORY_RARITY
             + this.segments[2] + p.CURSE_CHANCE
             + this.segments[3] + p.TRAIT_CHANCE
             + this.segments[4] + p.TRAIT_MIN_RARITY
             + this.segments[5] + p.arm_floor
             + this.segments[6] + p.cor_floor
             + this.segments[7] + p.leg_floor
             + this.segments[8] + p.arm_ceil
             + this.segments[9] + p.cor_ceil
             + this.segments[10] + p.leg_ceil
             + this.segments[11];
    return Pipeline.build(this.header, body);
  }
};
