const RarityTemplate = {
  header: "--BaRandom v21 by LoH\n--Use with: !bset tweakdefs0 <mod.b64>",
  segments: [
    "rename_list={}local a={\"Uncommon\",\"Rare\",\"Exceptional\",\"Epic\",\"Exotic\",\"Legendary\",\"Mythical\",\"Miracle\",\"Divine\",\"Eternal\",\"Supreme\",\"Omega\",\"Unique\",\"Jackpot\",\"Immortal\",\"Absurd\",\"Godlike\",\"TooRNG\",\"Insanely Lucky\",\"Dope\",\"Admin\",\"GOD\",\"ERROR\",\"Super Sayan\",\"Beyond\",\"MGGW\",\"AMBO\",\"Beyond All Reason\"}local b=",
    ";local c=",
    ";local d=",
    ";local e=",
    ";local f=",
    ";local g={",
    ",",
    ",",
    "}local h={",
    ",",
    ",",
    "}local i={cancloak=true,cloakcost=5,cloakcostmoving=15,mincloakdistance=75}local j={cancloak=true,cloakcost=5,cloakcostmoving=15,mincloakdistance=50}local k={[\"Glass Cannon\"]={{\"Phantom\",i,{hp=0.85}},{\"Volatile\",{},{dmg=1.3,hp=0.6}},{\"Overcharged\",{},{rld=0.8,energypershot=1.5}},{\"Plague\",{},{fs=1.0,aoe=1.15,dmg=0.9}},{\"Bouncer\",{},{impf=6.0,impb=2.0,dmg=0.6}}},[\"Tank\"]={{\"Juggernaut\",{},{hp=1.6,spd=0.7,turnrate=0.75}},{\"Regenerator\",{},{autoheal=3.0}},{\"Fortified\",{},{hp=1.3,rld=1.2}},{\"GravWell\",{},{impf=-2.0,aoe=1.4,dmg=0.8}}},[\"Sniper\"]={{\"Phantom\",i,{hp=0.9}},{\"Marksman\",{},{rng=1.3,acc=0.7,aoe=0.7}},{\"Piercing\",{},{dmg=1.2,aoe=0.5}},{\"Drunk\",{},{wob=4000,dnc=60,acc=2.5,aoe=1.3}}},[\"Brawler\"]={{\"Swift\",{},{spd=1.4,hp=0.7,maxacc=1.3}},{\"Berserker\",{},{dmg=1.2,aoe=1.3,acc=1.4}},{\"Siege\",{},{aoe=1.4,dmg=1.15,spd=0.85}},{\"Plague\",{},{fs=1.0,aoe=1.15,dmg=0.9}},{\"Bouncer\",{},{impf=6.0,impb=2.0,dmg=0.6}}},[\"Fortress\"]={{\"Juggernaut\",{},{hp=1.6}},{\"Shielded\",{},{shield_power=1.4,shield_radius=1.2}},{\"Siren\",{},{impf=3.5,impb=1.0,dmg=0.7,aoe=1.15}}},[\"Watchtower\"]={{\"Phantom\",j,{hp=0.9}},{\"Marksman\",{},{rng=1.3,acc=0.7,aoe=0.7}},{\"GravWell\",{},{impf=-2.0,aoe=1.4,dmg=0.8}}},[\"Suppressor\"]={{\"Siege\",{},{aoe=1.4,dmg=1.15,acc=1.3}},{\"Berserker\",{},{dmg=1.3,aoe=1.3}},{\"Siren\",{},{impf=3.5,impb=1.0,dmg=0.7,aoe=1.15}},{\"Drunk\",{},{wob=4000,dnc=60,acc=2.5,aoe=1.3}}}}local function l(m)local m=m or 0;if m+1<=#a and math.random()<b then m=l(m+1)end;return m end;local function n(o)local p=l(o)if p<o then p=o end;return p end;local function q(m,r,p,s,t)if m then local u=m*r^p+(r-1)*m;if m>0 and u<=0 then u=m*r^p end;if s then u=math.floor(u)end;return u*(t or 1)end end;local function v(u,w,r,p,s)u[w]=q(u[w],r,p,s)end;local function x(u,w,r,s)if r and u[w]then u[w]=u[w]*r;if s then u[w]=math.floor(u[w])end end end;local function y(z)return z:byte()==99 and 2 or z:byte()==108 and 3 or 1 end;local A={{\"Glass Cannon\",0.88,1.05,1.12,1.05,0.91,1.05,0.96},{\"Tank\",1.22,1.0,1.01,1.04,0.97,1.04,0.97},{\"Sniper\",1.03,1.04,1.07,1.14,0.98,0.95,0.91},{\"Brawler\",1.06,1.10,1.05,1.0,0.88,1.10,0.97}}local B={{\"Fortress\",1.20,1.0,1.08,1.04,0.97,1.04,0.97},{\"Watchtower\",1.03,1.0,1.05,1.14,0.98,0.95,0.91},{\"Suppressor\",1.06,1.0,1.04,1.0,0.88,1.12,0.97}}local C={{\"armthund\",\"armkam\"},{\"armpw\",\"armrock\",\"armham\",\"armwar\",\"armflea\"},{\"armmlv\",\"armfav\",\"armflash\",\"armpincer\",\"armstump\",\"armart\",\"armjanus\"},{\"armdecade\",\"armpt\",\"armpship\",\"armroy\",\"armsub\"},{\"armsh\",\"armanac\",\"armmh\"},{\"armsaber\",\"armsb\",\"armseap\"},{\"armbrawl\",\"armpnix\",\"armlance\",\"armdfly\",\"armblade\",\"armstil\",\"armliche\"},{\"armfast\",\"armamph\",\"armzeus\",\"armmav\",\"armsptk\",\"armfido\",\"armsnipe\",\"armfboy\",\"armspid\",\"armvader\",\"armscab\"},{\"armcroc\",\"armlatnk\",\"armbull\",\"armgremlin\",\"armmart\",\"armmerl\",\"armmanni\"},{\"armcrus\",\"armsubk\",\"armserp\",\"armantiship\",\"armbats\",\"armmship\",\"armepoch\",\"armlship\"},{\"armbanth\",\"armraz\",\"armmar\",\"armvang\",\"armlun\",\"armthor\"},{\"corshad\",\"corbw\"},{\"corak\",\"corstorm\",\"corthud\"},{\"cormlv\",\"corfav\",\"corgator\",\"corgarp\",\"corraid\",\"corlevlr\",\"corwolv\"},{\"coresupp\",\"corpt\",\"corpship\",\"corroy\",\"corsub\"},{\"corsh\",\"corsnap\",\"cormh\",\"corhal\"},{\"corcut\",\"corsb\",\"corseap\"},{\"corape\",\"corhurc\",\"cortitan\",\"corcrwh\"},{\"corpyro\",\"coramph\",\"corcan\",\"corsumo\",\"cortermite\",\"cormort\",\"corhrk\",\"corroach\",\"corsktl\",\"cormando\"},{\"corsala\",\"correap\",\"corparrow\",\"corgol\",\"corban\",\"cormart\",\"corvroc\",\"cortrem\"},{\"corcrus\",\"corshark\",\"corssub\",\"corantiship\",\"corbats\",\"cormship\",\"corblackhy\",\"corfship\"},{\"corkorg\",\"corkarg\",\"corjugg\",\"corshiva\",\"corcat\",\"corsok\",\"cordemon\"},{\"legkam\",\"legcib\",\"legmos\"},{\"leggob\",\"leglob\",\"legcen\",\"legbal\",\"legkark\"},{\"legscout\",\"leghades\",\"leghelios\",\"leggat\",\"legbar\",\"legmlv\",\"legamphtank\"},{\"legnavyscout\",\"legnavyfrigate\",\"legnavydestro\",\"legnavysub\",\"legnavyartyship\"},{\"legsh\",\"legner\",\"legmh\",\"legcar\"},{\"legspsurfacegunship\",\"legspcarrier\",\"legspbomber\",\"legsptorpgunship\"},{\"legstronghold\",\"legmineb\",\"legatorpbomber\",\"legfort\",\"legphoenix\"},{\"legstr\",\"legamph\",\"legshot\",\"leginc\",\"legsrail\",\"legbart\",\"leginfestor\",\"leghrk\",\"legsnapper\"},{\"legmrv\",\"legaskirmtank\",\"legfloat\",\"legaheattank\",\"legmed\",\"legamcluster\",\"legvcarry\",\"legavroc\",\"leginf\"},{\"leganavycruiser\",\"leganavyheavysub\",\"leganavybattlesub\",\"leganavybattleship\",\"leganavyartyship\",\"leganavymissileship\",\"leganavyflagship\",\"leganavyantiswarm\"},{\"legeheatraymech\",\"legeallterrainmech\",\"legjav\",\"legelrpcmech\",\"legehovertank\",\"legerailtank\",\"legeshotgunmech\",\"legkeres\"}}local D={}local E={}for F,G in ipairs(C)do local H={}for F,I in ipairs(G)do if not E[I]then H[#H+1]=I end end;if#H==0 then H=G end;local J=H[math.random(#H)]local K=y(J)local p=n(math.max(c,g[K]))if p>h[K]then p=h[K]end;D[J]=p;E[J]=true end;local L={}for M,N in pairs(UnitDefs)do if not D[M]then local O=N.weapondefs and N.builder~=true;if O and math.random()<d then local P=l()if P<1 then P=1 end;L[M]=P;D[M]=0 else local p=l()local K=y(M)if p<g[K]then p=g[K]end;if p>h[K]then p=h[K]end;D[M]=p end end end;local Q={}for M,N in pairs(UnitDefs)do local p=D[M]or 0;if p>=5 and N.weapondefs then if N.speed then Q[M]=A[math.random(#A)]elseif N.builder~=true then Q[M]=B[math.random(#B)]end end end;local R={}for M,N in pairs(UnitDefs)do local p=D[M]or 0;local S=Q[M]if p>=f and S then local T=k[S[1]]if T and math.random()<e then R[M]=T[math.random(#T)]end end end;for M,N in pairs(UnitDefs)do local U=D[M]or 0;local V=N.metalcost and\"metalcost\"or\"buildcostmetal\"local W=N.energycost and\"energycost\"or\"buildcostenergy\"local X=N.health and\"health\"or\"maxdamage\"if not N.power then N.power=N[V]+N[W]/60 end;local Y=N.customparams;local Z=U;if not(U<=#a)then U=#a end;if not(U<=6)and(M==\"armcom\"or M==\"corcom\"or M==\"legcom\")then U=6 end;local P=L[M]if P then if Y then Y.cursed=tostring(P)end;v(N,X,0.93,P,true)v(N,\"speed\",0.97,P,true)v(N,\"maxacc\",0.97,P)v(N,\"turnrate\",0.97,P)v(N,\"sightdistance\",0.97,P)v(N,\"radardistance\",0.97,P)v(N,V,0.85,P,true)v(N,W,0.85,P,true)v(N,\"buildtime\",0.88,P)if N.weapondefs then for F,_ in pairs(N.weapondefs)do if _.interceptor~=1 and _.targetable~=1 then v(_,\"range\",0.97,P,true)v(_,\"reloadtime\",1.04,P)if _.damage then for w,a0 in pairs(_.damage)do _.damage[w]=q(a0,0.94,P)end end end end end;if M then table.insert(rename_list,{M,\"prefix\",\"[Cursed Mk.\"..P..\"]\"})table.insert(rename_list,{M,\"desc_prefix\",\"Cursed Mk.\"..P..\" \"})end elseif Z>0 then if Y then Y.rarity=tostring(U)end;local S=Q[M]local a1=S and S[2]or 1.1;local a2=S and S[3]or 1.05;local a3=S and S[4]or 1.05;local a4=S and S[5]or 1.05;local a5=S and S[6]or 0.95;local a6=S and S[7]or 1.05;local a7=S and S[8]or 0.97;local a8=U;v(N,\"power\",1.2,a8)v(N,\"speed\",a2,a8,true)v(N,\"maxacc\",1.05,a8)v(N,\"maxdec\",1.05,a8)v(N,\"turnrate\",1.05,a8)v(N,\"sightdistance\",1.05,a8)v(N,\"radardistance\",1.1,a8)v(N,X,a1,a8,true)v(N,\"idleautoheal\",1.1,a8)v(N,\"energymake\",1.04,a8)v(N,\"extractsmetal\",1.1,a8)v(N,\"energyupkeep\",1.04,a8)v(N,\"tidalgenerator\",1.04,a8)v(N,\"windgenerator\",1.04,a8)if N.windgenerator and not Y.energymultiplier then v(N,V,0.97,a8,true)end;if N.tidalgenerator or N.windgenerator or N.builder==true or not N.speed and not N.weapondefs then v(N,V,0.97,a8,true)v(N,W,0.98,a8,true)v(N,\"buildtime\",0.98,a8)v(N,\"workertime\",1.05,a8,true)v(N,\"builddistance\",1.05,a8,true)else v(N,V,1.035,a8,true)v(N,W,1.04,a8,true)v(N,\"buildtime\",1.05,a8)v(N,\"workertime\",1.05,a8,true)v(N,\"builddistance\",1.05,a8,true)end;if Y then v(Y,\"energyconv_efficiency\",1.04,a8)v(Y,\"energyconv_capacity\",1.04,a8,true)v(Y,\"shield_power\",1.1,a8,true)v(Y,\"shield_radius\",1.05,a8,true)v(Y,\"energymultiplier\",1.04,a8,true)end;if N.weapondefs then for F,_ in pairs(N.weapondefs)do if _.interceptor==1 or _.targetable==1 then v(_,\"coverage\",1.02,a8,true)v(_.damage,\"default\",1.1,a8)v(_,\"areaofeffect\",1.01,a8)else local a9=_.customparams;if not _.reloadtime or _.reloadtime<0.034 then _.reloadtime=0.034 end;if _.burstrate and _.burstrate<0.034 then _.burstrate=0.034 end;if _.burst and _.burstrate then if _.burst*_.burstrate>_.reloadtime then _.reloadtime=_.burst*_.burstrate end end;if _.beamtime then if _.beamtime>_.reloadtime then _.reloadtime=_.beamtime end end;local aa=false;if _.burstrate and _.burst and _.reloadtime then local ab=_.burstrate*_.burst;if ab/_.reloadtime>=0.98 or ab>=_.reloadtime then aa=true end end;local ac=false;if _.beamtime and _.reloadtime then if _.beamtime/_.reloadtime>=0.90 or _.beamtime>=_.reloadtime then ac=true end end;v(_,\"reloadtime\",a5,a8)v(_,\"burstrate\",a5,a8)v(_,\"areaofeffect\",a6,a8)v(_,\"weaponvelocity\",1.05,a8)v(_,\"range\",a4,a8,true)v(_,\"flighttime\",1.05,a8)v(_,\"sprayangle\",a7,a8)v(_,\"accuracy\",a7,a8)v(_,\"energypershot\",1.1,a8,true)v(_,\"metalpershot\",1.05,a8,true)v(_,\"stockpiletime\",0.96,a8,true)v(_,\"startvelocity\",1.05,a8)v(_,\"turnrate\",1.03,a8)v(_,\"weaponacceleration\",1.05,a8)v(_,\"laserflaresize\",1.04,a8)v(_,\"size\",1.09,a8)v(_,\"thickness\",1.06,a8)if a9 then v(a9,\"overrange_distance\",a4,a8,true)v(a9,\"controlradius\",a4,a8,true)v(a9,\"engagementrange\",a4,a8,true)local ad=tonumber(a9.spark_range)if ad then a9.spark_range=tostring(q(ad,1.05,a8,true))end;v(a9,\"area_onhit_damage\",1.05,a8,true)v(a9,\"area_onhit_range\",1.05,a8,true)end;if _.damage then local ae=1;local af=0;local ag=_.reloadtime or 1;local ah=_.beamtime or 0;local ai=_.burstrate or 1;local aj=_.burst or 1;if ag<0.034 then ae=ae+0.034/ag-1;_.reloadtime=0.034;ag=0.034 end;local ak=a9 and a9.sweepfire;if ak or M==\"armbeamer\"then _.reloadtime=_.reloadtime or ag;ag=_.reloadtime end;if ah>ag then ae=ae+ah/ag-1;_.reloadtime=ah;ag=ah end;if ai<0.034 then ae=ae+0.034/ai-1;_.burstrate=0.034;ai=0.034 end;local ab=ai*aj;if _.burstrate and _.burst and ab>ag then ae=ae+ab/ag-1;_.reloadtime=ab end;for w,a0 in pairs(_.damage)do if a0==\"commanders\"then _.damage[w]=q(a0,1.02+af,a8,false,ae)else _.damage[w]=q(a0,a3+af,a8,false,ae)end end end;local al=_.shield;if al then v(al,\"power\",1.1,a8,true)v(al,\"powerregen\",1.1,a8,true)v(al,\"radius\",1.05,a8,true)v(al,\"force\",1.05,a8)v(al,\"powerregenenergy\",0.99,a8,true)end;if aa then _.reloadtime=_.burst*_.burstrate end;if ac then _.reloadtime=_.beamtime end end end end;local am=R[M]if am then for w,a0 in pairs(am[2])do N[w]=a0 end;local an=am[3]x(N,X,an.hp,true)x(N,\"speed\",an.spd,true)x(N,\"turnrate\",an.turnrate)x(N,\"maxacc\",an.maxacc)x(N,\"idleautoheal\",an.autoheal)if Y then x(Y,\"shield_power\",an.shield_power,true)x(Y,\"shield_radius\",an.shield_radius,true)end;if N.weapondefs then for ao,_ in pairs(N.weapondefs)do if _.interceptor~=1 and _.targetable~=1 then x(_,\"areaofeffect\",an.aoe,true)x(_,\"range\",an.rng,true)x(_,\"reloadtime\",an.rld)x(_,\"energypershot\",an.energypershot)x(_,\"sprayangle\",an.acc)x(_,\"accuracy\",an.acc)if an.dmg and _.damage then for w,a0 in pairs(_.damage)do _.damage[w]=a0*an.dmg end end;if an.impf then _.impulsefactor=an.impf end;if an.impb then _.impulseboost=an.impb end;if an.fs then _.firestarter=an.fs end;if an.wob then _.wobble=an.wob end;if an.dnc then _.dance=an.dnc end end end end end;if M then local ap=S and\" \"..S[1]or\"\"local aq=am and\" \"..am[1]or\"\"table.insert(rename_list,{M,\"prefix\",\"[\"..a[U]..aq..ap..\"]\"})table.insert(rename_list,{M,\"desc_prefix\",\"Mk.\"..U..\"   \"})end else if M then table.insert(rename_list,{M,\"prefix\",\"[Common]\"})table.insert(rename_list,{M,\"desc_prefix\",\"Mk.\"..U..\" \"})end end end;Spring.Echo(\"tweakdefs_rename_get_ready\")for ar,as in pairs(rename_list)do Spring.Echo(\"/(\"..as[1]..\"/-\"..as[2]..\"/-\"..as[3]..\"/)\")end;Spring.Echo(\"tweakdefs_rename_end\")"
  ],
  defaults: {
    rarity_chance: 0.7,
    MIN_FACTORY_RARITY: 7,
    CURSE_CHANCE: 0.1,
    TRAIT_CHANCE: 0.5,
    TRAIT_MIN_RARITY: 5,
    arm_floor: 0,
    cor_floor: 0,
    leg_floor: 0,
    arm_ceil: 28,
    cor_ceil: 28,
    leg_ceil: 28
  },
  build: function(params) {
    var p = {};
    for (var k in this.defaults) p[k] = this.defaults[k];
    for (var k in params) p[k] = params[k];
    var body = this.segments[0] + p.rarity_chance
             + this.segments[1] + p.MIN_FACTORY_RARITY
             + this.segments[2] + p.CURSE_CHANCE
             + this.segments[3] + p.TRAIT_CHANCE
             + this.segments[4] + p.TRAIT_MIN_RARITY
             + this.segments[5] + p.arm_floor
             + this.segments[6] + p.cor_floor
             + this.segments[7] + p.leg_floor
             + this.segments[8] + p.arm_ceil
             + this.segments[9] + p.cor_ceil
             + this.segments[10] + p.leg_ceil
             + this.segments[11];
    return Pipeline.build(this.header, body);
  }
};
