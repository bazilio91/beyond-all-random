# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Beyond All Random (BaR)** — a Lua mod suite for Beyond All Reason, a Spring RTS Engine game. Based on AMBO & MGGW's Random Rarities mod. Adds a random rarity system to units with faction-balanced guarantees, a viewer widget, and a balance patch. Files are pure Lua loaded directly by the Spring engine.

## Build & Serialize

Requires `luamin` (`npm install -g luamin`) for minification.

```bash
make          # minifies mod.lua and encodes to mod.b64 (URL-safe base64 for BAR lobby)
make clean    # removes mod.b64
```

The encoded output must stay under **16,384 chars** (BAR lobby slot limit). Apply in-game with `!bset tweakdefs0 <contents of mod.b64>`.

`serialize.sh` handles the pipeline: extracts leading `--` comment headers, minifies via `luamin`, prepends headers, and base64-encodes everything together.

## Architecture

### mod.lua — Core rarity modifier (3-pass structure)

**Pass 1a — Guaranteed spicy units:** Uses a static `factory_tree` (built from BAR game data via `build_factory_tree.py`) mapping each faction's factories to their combat units (AA, spy, decom, anti-nuke excluded). For each factory, picks a random combat unit and rolls rarity with floor 10 (Eternal). One random faction gets an additional boost to floor 15 (Immortal). Tracks already-boosted units in `guaranteed` table to avoid the same unit being picked for multiple factories.

**Pass 1b — Remaining units:** All units not already assigned get a normal `get_rarity()` roll (70% chance to escalate per tier, 28 tiers total).

**Pass 2 — Stat scaling:** Iterates all `UnitDefs`, applies exponential scaling formulas based on final rarity. Commander rarity capped at 6. Key multipliers: power 1.2, speed 1.05, health 1.1, damage 1.05, reload 0.95.

**Beam weapon handling:** Continuous beams detected when `beamtime/reloadtime >= 0.90` — reloadtime is reset to beamtime after scaling to preserve fire rate. Sweepfire weapons (Legion heat rays) skip the old dm compensation and let normal set_v scaling handle both damage and reload.

### Other files

- **random_stats_viewer.lua** — In-game UI widget. Parses `infolog.txt` to read rarity assignments, displays units organized by faction with color-coded rarity, stats, and factory build trees. Toggle with `/unitstats`.

- **disable_t3_air.lua** — Makes T3 air units prohibitively expensive.

- **factory_tree.lua** — Auto-generated from BAR game data. Maps faction → factory → combat unit names. Regenerate with `python3 build_factory_tree.py`.

- **Beyond-All-Reason/** — Shallow clone of the BAR game repo, used by `build_factory_tree.py` to extract unit definitions.

**Data flow:** `mod.lua` modifies UnitDefs and logs to infolog → `random_stats_viewer.lua` parses infolog and renders UI.

## Commit Conventions

Commits use prefixes parsed by `git-cliff` (see `cliff.toml`) to generate changelogs. Use these prefixes:

- `feat:` — New features (traits, archetypes, new systems)
- `fix:` — Bug fixes (scaling bugs, beam handling, edge cases)
- `balance:` — Balance changes (stat multiplier tweaks, rarity tuning)
- `ui:` — UI changes (viewer widget, web builder, GH Pages)
- `chore:` — Build/CI/docs (skipped in changelog)

Examples: `feat: add Plague trait`, `fix: beam reload at extreme rarity`, `balance: nerf Glass Cannon HP to 0.88`.

Unprefixed commits starting with Add/Fix/Update/Improve/Remove are auto-categorized. The `chore:` prefix (including version bump commits) is excluded from release notes.

## Versioning & Releases

- Version is an integer tag (`v5`, `v6`, ...) auto-incremented on every push to master via `.github/workflows/autobump.yml`
- The workflow updates version strings in `mod.lua` line 1 and `docs/js/rarity-template.js` header, commits with `[skip ci]`, tags, and creates a GitHub Release
- Release notes are generated by `git-cliff` from commit history between tags
- The GH Pages site fetches the latest version from the GitHub API at page load

## Spring Engine API Surface

- `UnitDefs` / `WeaponDefs` — global tables for unit and weapon definitions
- `Spring.Echo()` — logging to infolog.txt
- `VFS.LoadFile()` — reading files (e.g., infolog.txt)
- `gl.*` functions — OpenGL rendering (Color, Rect, Text, etc.)
- Widget callbacks: `widget:Initialize()`, `widget:DrawScreen()`, `widget:MousePress()`, `widget:MouseWheel()`, etc.
