name: Auto Bump Version

on:
  push:
    branches: [main, master]

permissions:
  contents: write

jobs:
  bump:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: tag
        run: |
          LATEST=$(git tag --sort=-v:refname | grep -E '^v[0-9]+$' | head -1)
          if [ -z "$LATEST" ]; then
            NEXT="v1"
          else
            NUM=${LATEST#v}
            NEXT="v$((NUM + 1))"
          fi
          echo "next=$NEXT" >> "$GITHUB_OUTPUT"

      - name: Update version strings
        run: |
          VERSION=${{ steps.tag.outputs.next }}
          sed -i "1s/--BaRandom .* by LoH/--BaRandom $VERSION by LoH/" mod.lua
          sed -i "s/--BaRandom v[0-9]* by LoH/--BaRandom $VERSION by LoH/" docs/js/rarity-template.js

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add mod.lua docs/js/rarity-template.js
          git diff --cached --quiet || git commit -m "chore: bump version to ${{ steps.tag.outputs.next }} [skip ci]"
          git push

      - name: Generate changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --unreleased --strip header
        env:
          OUTPUT: CHANGES.md
          GITHUB_REPO: ${{ github.repository }}

      - name: Create tag and release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git tag ${{ steps.tag.outputs.next }}
          git push origin ${{ steps.tag.outputs.next }}
          gh release create ${{ steps.tag.outputs.next }} \
            --title "${{ steps.tag.outputs.next }}" \
            --notes-file CHANGES.md
